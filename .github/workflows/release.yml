name: Release and Deploy
on:
  release:
    types: [created]

env:
  GO_VERSION: '1.25'
  ACR_REGISTRY: 'graphqlserver.azurecr.io'
  IMAGE_NAME: 'graphqlserver'

jobs:
  # Job 1: Tests con validación de cobertura
  test:
    name: Testing and Coverage
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Build
      run: go build -v ./...

    - name: Run Tests
      run: go test -race -covermode=atomic -v ./... -coverprofile=coverage.txt

    - name: Calculate and validate coverage
      run: |
        COVERAGE=$(go tool cover -func=coverage.txt | grep total | awk '{print $3}' | sed 's/%//')
        echo "Coverage: $COVERAGE%"

        # Convertir a entero para comparación
        COVERAGE_INT=$(echo "$COVERAGE" | cut -d'.' -f1)

        if [ "$COVERAGE_INT" -lt 1 ]; then
          echo "❌ Coverage is below 1% ($COVERAGE%). Build failed."
          exit 1
        else
          echo "✅ Coverage is $COVERAGE% - meets minimum requirement of 1%"
        fi

  # Job 2: Linter golangci-lint
  golangci:
    name: Linter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.4.0

  # Job 3: SAST con gosec
  sast:
    name: SAST Scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install gosec
      run: go install github.com/securego/gosec/v2/cmd/gosec@latest

    - name: Run gosec (SAST scan)
      run: gosec -exclude-generated -exclude=G115,G401 ./...

  # Job 4: Build y Push a Azure Container Registry
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [test, golangci, sast]

    steps:
    - uses: actions/checkout@v4

    - name: Get release tag
      id: release
      run: echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT

    - name: Login to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.ACR_REGISTRY }}
        username: ${{ secrets.AZURE_CLIENT_ID }}
        password: ${{ secrets.AZURE_CLIENT_SECRET }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: |
          ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.release.outputs.tag }}
          ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Image digest
      run: |
        echo "✅ Image pushed successfully:"
        echo "  ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.release.outputs.tag }}"
        echo "  ${{ env.ACR_REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
