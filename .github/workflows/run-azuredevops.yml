name: Deploy to Azure
on:
  release:
    types: [created]

jobs:
  trigger-azure-devops:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.release.target_commitish }}

    - name: Get branch name
      id: branch
      run: |
        # Obtener la rama desde donde se creÃ³ el release
        BRANCH="${{ github.event.release.target_commitish }}"
        echo "branch_name=$BRANCH" >> $GITHUB_OUTPUT
        echo "Release created from branch: $BRANCH"

    - name: Get Release Tag
      id: release
      run: echo "tag_name=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT

    - name: Trigger Azure DevOps Pipeline
      run: |
        curl -u ":${{ secrets.AZURE_DEVOPS_PAT }}" \
          -X POST \
          -H "Content-Type: application/json" \
          -d "{
            \"templateParameters\": {
              \"RELEASE_TAG\": \"${{ steps.release.outputs.tag_name }}\"
            },
            \"resources\": {
              \"repositories\": {
                \"self\": {
                  \"refName\": \"refs/heads/${{ steps.branch.outputs.branch_name }}\"
                }
              }
            }
          }" \
          "https://dev.azure.com/carlossolar20608/graphql-server/_apis/pipelines/1/runs?api-version=7.1-preview.1"
      env:
        AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
